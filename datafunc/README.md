# Data
## NextBus API
NextBus is a company that partners with municipal transit agencies to provide information on bus locations and predictions. AC Transit, which serves the Alameda-Contra Costa area, provides access "Real-Time Departures" of its buses to the public via its website, app, and an [API](http://www.actransit.org/rider-info/nextbus-xml-data/). The data is provided in XML format.

### Bus Stops
First, we needed data on the bus routes. See the `getRoutes` function in `getroutes.py`, and `routes.csv`. This returned a simple list of all the bus routes that ACTransit services. However, the routes of interest in the UC Berkeley vicinity are the **6, 7, 12, 18, 36, 51B, 52, 65, 67, 79, 88, and F**. Next, we collected the stops along those routes, in both directions. See `routeConfig` in `getroutes.py`. Over a thousand stops were stored in `stops.csv`. Narrowing to a more specific area around campus, arbitrary boundaries were set to filter only stops in this area. Those stops (about a hundred) were stored in `localstops.csv`, and as stops along each of the routes in the `routes/` directory, under the naming convention `[ROUTE]_[DIRECTION NAME].csv`.

### Bus Predictions
`getpredictions.py` polls and parses XML feeds
retrieved for each stop (specifically by stop ID) in `localstops.csv`. Stop predictions along each route for both directions are recorded in the `predictions/` directory, under the naming convention `[STOPID]_[ROUTE]_[DIRECTION NAME].csv`.

`getpredictions.py` should be run as a [cronjob](https://code.tutsplus.com/tutorials/scheduling-tasks-with-cron-jobs--net-8800), ideally at every minute so that prediction
updates can be observed carefully. Each prediction was concatenated as a new line in the appropriate CSV file. For this story, this file was run every minute from September 5, 2017 to October 17, 2017. *This resulted in a `predictions/` directory that was well over 1GB, so the data is not stored in this repository.*

### GPX
For drawing routes and stops onto a JavaScript map, the data needed to be converted to GPX format. For stops, this was straightforward and done in `toGPX.py`. For routes, it was more tricky. I manually looked up bus routes on Google Maps, then used an online resource that input Google Maps directions links and output GPX files. This was not ideal, but because of the relatively small number of routes, it was not very difficult. That data is stored in `src/data/stops` and `src/data/gpx`.

# Calculating Delay
Bus predictions at a given stop update from when an upcoming bus is close enough to begin predictions (usually between 90 to 60 minutes from arrival) until that bus has passed the stop (0 minutes). Predictions from 60 or 90 minutes out are far too unreliable, so a more reasonable 20 minutes was chosen. Each bus was evaluated based on this 20-minute prediction, comparing the predicted arrival and the actual arrival time (at 0 minutes).

`delay.py` takes the CSVs generated by `getpredictions.py` and calculates delays (and other potentially useful statistics) for each stop, line, and line-specific stop. Recall that there can be multiple lines at each stop, so the third category is very important.

This data was then repackaged into a JSON file, `data.json`, which can be found in the `/src/data` directory.
